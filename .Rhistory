# add the observed data
geom_line(
aes(y = rate, group = curve_id),
data = filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
)
nd %>%
add_linpred_draws(m_UTPC,ndraws=1000,re_formula = NA) %>%
ggplot(aes(x=temp,y=.linpred))+
geom_line(aes(group=.draw),alpha=.01)+
# add the observed data
geom_line(
aes(y = rate, group = curve_id),
data = filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
) +
coord_cartesian(ylim=c(0,4))
m_UTPC
pp_check(m_UTPC, ndraws = 100)
nd %>%
add_linpred_draws(m_UTPC,ndraws=1000,re_formula = NA) %>%
ggplot(aes(x=temp,y=.linpred))+
geom_line(aes(group=.draw),alpha=.01)+
# add the observed data
geom_line(
aes(y = rate, group = curve_id),
data = d_hier
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
) +
coord_cartesian(ylim=c(0,4))
# Compare to the pawar model that converged
loo(bayesian_model_hier_topt,m_UTPC)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp = as.factor(growth_temp)
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
backend = "cmdstanr"
)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp_fct = as.factor(growth_temp)
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
backend = "cmdstanr"
)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp_fct = as.factor(growth_temp)
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
backend = "cmdstanr"
)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp_fct = as.factor(growth_temp)
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 1000,
backend = "cmdstanr"
)
bform_UTPC_3temp_lognormal <- bf(
rate ~ log(yopt) + ((temp - Topt) / Delta) + log(1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp_lognormal <- brm(
bform_UTPC_3temp_lognormal,
family = brmsfamily("lognormal"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 1000,
backend = "cmdstanr"
)
priors
m_UTPC_3temp_lognormal$prior
m_UTPC_3temp_lognormal
m_UTPC_3temp
yopt_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="yopt",
points = .5,
re_formula = NA
)+ylab("yopt")
Topt_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="Topt",
points = .5,
re_formula = NA
)+ylab("Topt")
Delta_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="Delta",
points = .5,
re_formula = NA
)+ylab("Delta")
patchwork::wrap_plots(yopt_plot,Topt_plot,Delta_plot)
plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("temp", "growth_temp_fct"),
points = .5,
re_formula = NA
)
patchwork::wrap_plots(yopt_plot,Topt_plot,Delta_plot,guides = "collect")
yopt_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="yopt",
points = .5,
re_formula = NA
)+labs(y="yopt",title="yopt",x="Growth temperature")
Topt_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="Topt",
points = .5,
re_formula = NA
)+labs(y="Topt",title="Topt",x="Growth temperature")
Delta_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="Delta",
points = .5,
re_formula = NA
)+labs(y="Delta",title="Delta",x="Growth temperature")
patchwork::wrap_plots(yopt_plot,Topt_plot,Delta_plot,axes = "collect")
plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("temp", "growth_temp_fct"),
points = .5,
re_formula = NA
)+
labs(fill="Growth temperature",colour="Growth temperature")
plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("temp", "growth_temp_fct"),
points = .5,
re_formula = NA
)+
labs(fill="Growth\ntemperature",colour="Growth\ntemperature",
x="Temperature",y="Metabolic rate")
library(knitr)
knitr::opts_chunk$set(fig.path = '../assets/img/2025-11-16-hierarchical-universal-thermal-performance-curves/', fig.width = 6, fig.height = 4)
plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("temp", "growth_temp_fct"),
points = .5,
re_formula = NA
)+
labs(fill="Growth\ntemperature",colour="Growth\ntemperature",
x="Temperature",y="Metabolic rate")
bform_UTPC_3temp_lognormal <- bf(
rate ~ log(yopt) + ((temp - Topt) / Delta) + log(1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
set.seed(42)
library(rTPC)
library(tidyverse)
library(ggrepel)
theme_set(theme_bw())
# Prepare for Stan and brms
library(brms)
options(brms.backend = "cmdstanr")
library(marginaleffects) # for convenient predictions
library(ggdist)
library(tidybayes)
## get curve data
data("chlorella_tpc")
d_ave <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
# our rate will be the metabolic rate of photosynthesis
flux == 'photosynthesis'
) %>%
group_by(temp) %>%
# Get the average, SD, and SE
summarise(
.,
sd = sd(rate),
ave_rate = mean(rate),
n = n(),
se = sd / sqrt(n)
) %>%
ungroup()
# plot
ggplot() +
geom_linerange(aes(x = temp, ymin = ave_rate - sd, ymax = ave_rate + sd), d_ave) +
geom_point(aes(temp, ave_rate), d_ave, size = 2, shape = 21, fill = 'green4') +
theme_bw(base_size = 12) +
theme(legend.position = 'none',
strip.text = element_text(hjust = 0),
strip.background = element_blank()) +
labs(x ='Temperature (ÂºC)',
y = 'Metabolic rate',
title = 'Photosynthesis rates across temperatures') +
geom_hline(aes(yintercept = 0), linetype = 2)
# Fit with nls.multstart
ml_model_weighted <- nls.multstart::nls_multstart(
ave_rate ~ pawar_2018(temp = temp, rtref, e, eh, topt, tref = 20),
data = d_ave,
iter = c(4, 4, 4, 4),
start_lower = get_start_vals(
d_ave$temp,
d_ave$ave_rate,
model_name = 'pawar_2018'
) -
10,
start_upper = get_start_vals(
d_ave$temp,
d_ave$ave_rate,
model_name = 'pawar_2018'
) +
10,
lower = get_lower_lims(d_ave$temp, d_ave$ave_rate, model_name = 'pawar_2018'),
upper = get_upper_lims(d_ave$temp, d_ave$ave_rate, model_name = 'pawar_2018'),
supp_errors = 'Y',
convergence_count = FALSE,
# include weights here!
modelweights = 1 / sd
)
summary(ml_model_weighted)
bform_UTPC_3temp_lognormal <- bf(
rate ~ log(yopt) + ((temp - Topt) / Delta) + log(1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp_lognormal <- brm(
bform_UTPC_3temp_lognormal,
family = brmsfamily("lognormal"),
data = d_hier_3temp,
prior = priors,
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
file = ".brms/utpc-1"
)
m_UTPC_3temp_lognormal
m_UTPC_3temp_lognormal <- brm(
bform_UTPC_3temp_lognormal,
family = brmsfamily("lognormal"),
data = d_hier_3temp,
prior = priors,
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
file = ".brms/utpc-1",
seed = 123
)
list.files(".brms")
m_UTPC_3temp_lognormal <- brm(
bform_UTPC_3temp_lognormal,
family = brmsfamily("lognormal"),
data = d_hier_3temp,
prior = priors,
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
file = ".brms/utpc-1-log",
seed = 123
)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp_fct = as.factor(growth_temp)
)
m_UTPC_3temp_lognormal <- brm(
bform_UTPC_3temp_lognormal,
family = brmsfamily("lognormal"),
data = d_hier_3temp,
prior = priors,
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
file = ".brms/utpc-2-log",
seed = 123
)
priors <- c(
prior(normal(2, 0.25), lb = 0, nlpar = "yopt"),
prior(normal(1, 3), lb = 0, ub = 20, nlpar = "Delta"),
prior(normal(40, 3), lb = 30, ub = 50, nlpar = "Topt"),
prior(normal(0, 0.3), lb = 0, class = "sd", nlpar = "yopt"),
prior(std_normal(), lb = 0, class = "sd", nlpar = "Topt"),
prior(normal(0, 0.3), lb = 0, class = "sd", nlpar = "Delta"),
prior(normal(0, 0.1), lb = 0, class = "sigma")
)
m_UTPC_3temp_lognormal <- brm(
bform_UTPC_3temp_lognormal,
family = brmsfamily("lognormal"),
data = d_hier_3temp,
prior = priors,
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
file = ".brms/utpc-2-log",
seed = 123
)
m_UTPC_3temp_lognormal
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
file = ".brms/utpc-2",
seed = 123
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
file = ".brms/utpc-2",
seed = 123
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
# file = ".brms/utpc-2",
seed = 1234
)
m_UTPC_3temp
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 500,
backend = "cmdstanr",
file = ".brms/utpc-2",
seed = 1234
)
