growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
) +
geom_line(aes(colour = model),show.legend = F) +
geom_ribbon(
aes(fill = model, ymin = conf.low, ymax = conf.high),
alpha = 0.2,
show.legend = F
) +
facet_wrap(~model, nrow = 1)
?pawar_2018
# Don't do any averaging!
d_hier <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
d_hier
# Start with just random effects on t_opt
bform_hier_topt <- bf(
rate ~  pawar_2018a(temp, rtref, e, eh, topt),
rtref ~ 1 ,
e ~ 1,
eh ~ 1 ,
topt ~ 1 + (1 | curve_id),
nl = TRUE
)
# Update the priors
priors_hier <- c(
priors,
# half-normal with low sd -- close to zero
prior(normal(0,0.3),lb=0,class="sd")
)
bayesian_model_hier_topt <- brm(
bform_hier_topt,
family = brmsfamily("gaussian"),
data = d_hier,
stanvars = stanvars_pawar_2018a,
prior = priors_hier,
control = list(adapt_delta = 0.999, max_treedepth = 15),
cores = 4,
iter = 4000,
warmup = 3000,
refresh = 1000,
backend = "cmdstanr"
)
# Update the priors
priors_hier <- c(
priors,
# half-normal with low sd -- close to zero
prior(normal(0,0.3),lb=0,class="sd",nlpar="topt")
)
bayesian_model_hier_topt <- brm(
bform_hier_topt,
family = brmsfamily("gaussian"),
data = d_hier,
stanvars = stanvars_pawar_2018a,
prior = priors_hier,
control = list(adapt_delta = 0.999, max_treedepth = 15),
cores = 4,
iter = 4000,
warmup = 3000,
refresh = 1000,
backend = "cmdstanr"
)
summary(bayesian_model_hier_topt)
# Don't do any averaging!
d_hier <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
d_hier
# Start with just random effects on t_opt
bform_hier_topt <- bf(
rate ~  pawar_2018a(temp, rtref, e, eh, topt),
rtref ~ 1 ,
e ~ 1,
eh ~ 1 ,
topt ~ 1 + (1 | curve_id), # <---- Note the familiar syntax used here :)
nl = TRUE
)
# Update the priors
priors_hier <- c(
priors,
# half-normal with low sd -- close to zero
prior(normal(0,0.3),lb=0,class="sd",nlpar="topt")
)
bayesian_model_hier_topt <- brm(
bform_hier_topt,
family = brmsfamily("gaussian"),
data = d_hier,
stanvars = stanvars_pawar_2018a,
prior = priors_hier,
control = list(adapt_delta = 0.999, max_treedepth = 15),
cores = 4,
iter = 4000,
warmup = 3000,
refresh = 1000,
backend = "cmdstanr"
)
summary(bayesian_model_hier_topt)
# Add a random effect on eh? (deactivation energy might vary among individuals)
bform_hier_topt_eh <- bf(
rate ~  pawar_2018a(temp, rtref, e, eh, topt),
rtref ~ 1 ,
e ~ 1,
eh ~ 1 + (1 | curve_id),
topt ~ 1 + (1 | curve_id),
nl = TRUE
)
# Update the priors
priors_hier <- c(
priors,
# half-normal with low sd -- close to zero
prior(normal(0,0.3),lb=0,class="sd",nlpar="topt"),
prior(normal(0,0.3),lb=0,class="sd",nlpar="eh")
)
bayesian_model_hier_topt_eh <- brm(
bform_hier_topt_eh,
family = brmsfamily("gaussian"),
data = d_hier,
stanvars = stanvars_pawar_2018a,
prior = priors_hier,
control = list(adapt_delta = 0.999, max_treedepth = 15),
cores = 4,
iter = 4000,
warmup = 3000,
refresh = 1000,
backend = "cmdstanr"
)
summary(bayesian_model_hier_topt_eh)
length(unique(d_hier$curve_id))
# Model -------------------------------------------------------------------
# See https://github.com/AndrewLJackson/UTPC-paper/blob/main/import-fit-merge.Rmd#L132C9-L132C68
# performance ~ (yopt * exp( (ta - Topt)/Delta ) * (1 - (ta - Topt)/Delta))
# ta = temp in Celcius!
bform <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 1 + (1 | curve_id),
Topt ~ 1 + (1 | curve_id),
Delta ~ 1 + (1 | curve_id),
nl = TRUE
)
priors <- c(
prior(normal(2, 0.25), lb = 0, nlpar = "yopt"),
prior(normal(1, 3), lb = 0, ub = 20, nlpar = "Delta"),
prior(normal(40, 3), lb = 30, ub = 50, nlpar = "Topt"),
prior(normal(0, 0.3), lb = 0, class = "sd", nlpar = "yopt"),
prior(std_normal(), lb = 0, class = "sd", nlpar = "Topt"),
prior(normal(0, 0.3), lb = 0, class = "sd", nlpar = "Delta"),
prior(normal(0, 0.1), lb = 0, class = "sigma")
)
m_UTPC <- brm(
bform,
family = brmsfamily("gaussian"),
data = d_hier,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.9, max_treedepth = 12),
cores = 4,
iter = 1000,
backend = "cmdstanr",
seed = 42
)
m_UTPC
plot(
conditional_effects(m_UTPC, effects = "temp", spaghetti = T, ndraws = 500),
points = T
)
plot(m_UTPC, ask = F)
pp_check(m_UTPC, ndraws = 100)
mcmc_plot(m_UTPC, type = "nuts_treedepth")
mcmc_plot(m_UTPC, type = "nuts_acceptance")
mcmc_plot(m_UTPC, type = "nuts_stepsize")
plot_predictions(m_UTPC,by="temp",newdata = nd)
plot_predictions(m_UTPC,by="temp",newdata = nd,re_formula=NA)
plot_predictions(m_UTPC,by="temp",newdata = nd,re_formula=NA)+
coord_cartesian(ylim=c(0,5))
nd %>%
add_linpred_draws(bayesian_model_hier_topt_eh,ndraws=1000,re_formula = NA) %>%
ggplot(aes(x=temp,y=.linpred))+
geom_line(aes(group=.draw),alpha=.01)
nd %>%
add_linpred_draws(bayesian_model_hier_topt_eh,ndraws=1000,re_formula = NA) %>%
ggplot(aes(x=temp,y=.linpred))+
geom_line(aes(group=.draw),alpha=.01)+
# add the observed data
geom_line(
aes(y = rate, group = curve_id),
data = filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
) +
```
nd %>%
add_linpred_draws(bayesian_model_hier_topt_eh,ndraws=1000,re_formula = NA) %>%
ggplot(aes(x=temp,y=.linpred))+
geom_line(aes(group=.draw),alpha=.01)+
# add the observed data
geom_line(
aes(y = rate, group = curve_id),
data = filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
)
m_UTPC +
coord_cartesian(ylim=c(0,4))
plot_predictions(m_UTPC,re_formula=NA) +
coord_cartesian(ylim=c(0,4))
plot_predictions(m_UTPC,by="temp",newdata = nd,re_formula=NA) +
coord_cartesian(ylim=c(0,4))
nd %>%
add_linpred_draws(m_UTPC,ndraws=1000,re_formula = NA) %>%
ggplot(aes(x=temp,y=.linpred))+
geom_line(aes(group=.draw),alpha=.01)+
# add the observed data
geom_line(
aes(y = rate, group = curve_id),
data = filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
)
nd %>%
add_linpred_draws(m_UTPC,ndraws=1000,re_formula = NA) %>%
ggplot(aes(x=temp,y=.linpred))+
geom_line(aes(group=.draw),alpha=.01)+
# add the observed data
geom_line(
aes(y = rate, group = curve_id),
data = filter(
chlorella_tpc,
process == 'adaptation',
growth_temp == 33,
flux == 'photosynthesis'
) %>%
mutate(curve_id = as.factor(curve_id)) %>%
as_tibble()
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
) +
coord_cartesian(ylim=c(0,4))
m_UTPC
pp_check(m_UTPC, ndraws = 100)
nd %>%
add_linpred_draws(m_UTPC,ndraws=1000,re_formula = NA) %>%
ggplot(aes(x=temp,y=.linpred))+
geom_line(aes(group=.draw),alpha=.01)+
# add the observed data
geom_line(
aes(y = rate, group = curve_id),
data = d_hier
) +
geom_pointrange(
aes(y = ave_rate, ymax = ave_rate + sd, ymin = ave_rate - sd),
shape = 21, fill = 'green4',
data = d_ave
) +
coord_cartesian(ylim=c(0,4))
# Compare to the pawar model that converged
loo(bayesian_model_hier_topt,m_UTPC)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp = as.factor(growth_temp)
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
backend = "cmdstanr"
)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp_fct = as.factor(growth_temp)
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
backend = "cmdstanr"
)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp_fct = as.factor(growth_temp)
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
backend = "cmdstanr"
)
d_hier_3temp <- filter(
chlorella_tpc,
process == 'adaptation',
growth_temp %in% c(27, 30, 33),
flux == 'photosynthesis'
) %>%
mutate(
curve_id = as.factor(curve_id),
growth_temp_fct = as.factor(growth_temp)
)
bform_UTPC_3temp <- bf(
rate ~ yopt * exp((temp - Topt) / Delta) * (1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp <- brm(
bform_UTPC_3temp,
family = brmsfamily("gaussian"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 1000,
backend = "cmdstanr"
)
bform_UTPC_3temp_lognormal <- bf(
rate ~ log(yopt) + ((temp - Topt) / Delta) + log(1 - (temp - Topt) / Delta),
yopt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Topt ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
Delta ~ 0 + (1 | gr(curve_id,by=growth_temp_fct)) + growth_temp_fct,
nl = TRUE
)
m_UTPC_3temp_lognormal <- brm(
bform_UTPC_3temp_lognormal,
family = brmsfamily("lognormal"),
data = d_hier_3temp,
prior = priors,
# sample_prior = "only",
control = list(adapt_delta = 0.99, max_treedepth = 12),
cores = 4,
iter = 2000,
warmup = 1500,
refresh = 1000,
backend = "cmdstanr"
)
priors
m_UTPC_3temp_lognormal$prior
m_UTPC_3temp_lognormal
m_UTPC_3temp
yopt_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="yopt",
points = .5,
re_formula = NA
)+ylab("yopt")
Topt_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="Topt",
points = .5,
re_formula = NA
)+ylab("Topt")
Delta_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="Delta",
points = .5,
re_formula = NA
)+ylab("Delta")
patchwork::wrap_plots(yopt_plot,Topt_plot,Delta_plot)
plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("temp", "growth_temp_fct"),
points = .5,
re_formula = NA
)
patchwork::wrap_plots(yopt_plot,Topt_plot,Delta_plot,guides = "collect")
yopt_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="yopt",
points = .5,
re_formula = NA
)+labs(y="yopt",title="yopt",x="Growth temperature")
Topt_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="Topt",
points = .5,
re_formula = NA
)+labs(y="Topt",title="Topt",x="Growth temperature")
Delta_plot <- plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("growth_temp_fct"),
nlpar="Delta",
points = .5,
re_formula = NA
)+labs(y="Delta",title="Delta",x="Growth temperature")
patchwork::wrap_plots(yopt_plot,Topt_plot,Delta_plot,axes = "collect")
plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("temp", "growth_temp_fct"),
points = .5,
re_formula = NA
)+
labs(fill="Growth temperature",colour="Growth temperature")
plot_predictions(
m_UTPC_3temp_lognormal,
condition = c("temp", "growth_temp_fct"),
points = .5,
re_formula = NA
)+
labs(fill="Growth\ntemperature",colour="Growth\ntemperature",
x="Temperature",y="Metabolic rate")
